name: ğŸ¯ Build APK - Corte de Matos (MEGA ROBUST)

on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production

jobs:
  build:
    name: ğŸ“± Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Instalando dependÃªncias..."
          npm ci --legacy-peer-deps --no-audit --no-fund

      - name: ğŸ”§ Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ”‘ Setup Android keystore
        run: |
          echo "ğŸ”‘ Configurando keystore..."
          echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 --decode > my-release-key.jks
          
          cat > credentials.json << EOF
          {
            "android": {
              "keystore": {
                "keystorePath": "./my-release-key.jks",
                "keystorePassword": "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}",
                "keyAlias": "${{ secrets.ANDROID_KEY_ALIAS }}",
                "keyPassword": "${{ secrets.ANDROID_KEY_PASSWORD }}"
              }
            }
          }
          EOF
          
          echo "âœ… Keystore configurado!"

      - name: ğŸ”§ Multi-Strategy EAS Configuration
        run: |
          echo "ğŸ”§ ConfiguraÃ§Ã£o EAS com mÃºltiplas estratÃ©gias..."
          
          PROJECT_ID="84ea4587-b864-4560-a167-05855903311c"
          
          # EstratÃ©gia 1: eas init com ID especÃ­fico
          echo "ğŸ“ EstratÃ©gia 1: eas init --id"
          npx eas init --id $PROJECT_ID --force --non-interactive && echo "âœ… EstratÃ©gia 1 funcionou!" || echo "âŒ EstratÃ©gia 1 falhou"
          
          # EstratÃ©gia 2: Verificar e adicionar projectId manualmente se necessÃ¡rio
          echo "ğŸ“ EstratÃ©gia 2: Verificar projectId no app.json"
          if ! grep -q "\"projectId\"" app.json; then
            echo "Adicionando projectId manualmente..."
            cp app.json app.json.backup
            jq --arg id "$PROJECT_ID" '.expo.projectId = $id' app.json > app.json.tmp && mv app.json.tmp app.json
            echo "âœ… ProjectId adicionado manualmente!"
          else
            echo "âœ… ProjectId jÃ¡ existe no app.json"
          fi
          
          # EstratÃ©gia 3: Criar .easrc se necessÃ¡rio
          echo "ğŸ“ EstratÃ©gia 3: Criar .easrc"
          echo '{"cli": {"appVersionSource": "local"}}' > .easrc
          
          # Verificar configuraÃ§Ã£o final
          echo "ğŸ“„ ConfiguraÃ§Ã£o final:"
          echo "App.json projectId:"
          cat app.json | jq '.expo.projectId' || echo "NÃ£o encontrado"
          echo "EAS.json:"
          cat eas.json | jq '.build' || echo "NÃ£o encontrado"
          echo "Credentials.json existe: $(test -f credentials.json && echo 'SIM' || echo 'NÃƒO')"
          
          echo "âœ… ConfiguraÃ§Ã£o multi-estratÃ©gia completa!"

      - name: ğŸ”¨ Robust Build Process
        run: |
          echo "ğŸ”¨ Processo de build robusto..."
          
          # Tentar build com diferentes abordagens
          echo "ğŸš€ Tentativa 1: Build padrÃ£o"
          if npx eas build --platform android --profile ${{ github.event.inputs.profile }} --non-interactive --wait; then
            echo "âœ… Build bem-sucedido na tentativa 1!"
            exit 0
          fi
          
          echo "ğŸ”„ Tentativa 2: Build apÃ³s reconfiguraÃ§Ã£o"
          npx eas init --force --non-interactive || true
          if npx eas build --platform android --profile ${{ github.event.inputs.profile }} --non-interactive --wait; then
            echo "âœ… Build bem-sucedido na tentativa 2!"
            exit 0
          fi
          
          echo "ğŸ”„ Tentativa 3: Build com clear cache"
          npx eas build --clear-cache --platform android --profile ${{ github.event.inputs.profile }} --non-interactive --wait || echo "âŒ Todas as tentativas falharam"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: âœ… Success
        run: |
          echo "ğŸ‰ Build finalizado com sucesso!"
          echo ""
          echo "ğŸ“± COMO BAIXAR O APK:"
          echo "1. Acesse: https://expo.dev/accounts/pikulito/projects/corte-matos-app/builds"
          echo "2. Procure pelo build mais recente (hoje: $(date))"
          echo "3. Clique no botÃ£o 'Download' ao lado do APK"
          echo ""
          echo "ğŸ“‹ INFORMAÃ‡Ã•ES DO BUILD:"
          echo "- Profile: ${{ github.event.inputs.profile }}"
          echo "- Plataforma: Android"
          echo "- Tipo: APK"
          echo "- Data: $(date)"
          echo ""
          echo "ğŸ”— LINKS DIRETOS:"
          echo "- Painel EAS: https://expo.dev/accounts/pikulito/projects/corte-matos-app/builds"
          echo "- Projeto Expo: https://expo.dev/accounts/pikulito/projects/corte-matos-app"
          echo ""
          echo "âœ… APK pronto para download no painel EAS Build!"
