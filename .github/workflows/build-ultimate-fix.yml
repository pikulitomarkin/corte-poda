name: ğŸ¯ Build APK - ULTIMATE FIX (NPM Error Resolved)

on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production

jobs:
  build:
    name: ğŸ“± Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Instalando dependÃªncias..."
          npm ci --legacy-peer-deps --no-audit --no-fund

      - name: ğŸ§¹ Clear npm cache and fix permissions
        run: |
          echo "ğŸ§¹ Limpando cache npm e corrigindo permissÃµes..."
          npm cache clean --force
          rm -rf ~/.npm
          rm -rf node_modules/.bin
          npm config set fund false
          npm config set audit false
          echo "âœ… Cache limpo!"

      - name: ğŸ”§ Install EAS CLI manually
        run: |
          echo "ğŸ”§ Instalando EAS CLI manualmente..."
          
          # MÃ©todo 1: npm install global
          npm install -g eas-cli@latest --force --no-fund --no-audit || echo "MÃ©todo 1 falhou"
          
          # MÃ©todo 2: Instalar localmente
          npm install eas-cli@latest --save-dev --legacy-peer-deps || echo "MÃ©todo 2 falhou"
          
          # MÃ©todo 3: Download direto
          curl -sSL https://get.expo.dev/eas | bash || echo "MÃ©todo 3 falhou"
          
          # Verificar qual mÃ©todo funcionou
          echo "ğŸ” Verificando instalaÃ§Ãµes:"
          which eas || echo "eas global nÃ£o encontrado"
          ./node_modules/.bin/eas --version || echo "eas local nÃ£o encontrado"
          npx eas --version || echo "npx eas nÃ£o funciona"
          
          echo "âœ… Tentativas de instalaÃ§Ã£o concluÃ­das!"

      - name: ğŸ” Setup Expo Token
        run: |
          echo "ğŸ” Configurando token Expo..."
          export EXPO_TOKEN="${{ secrets.EXPO_TOKEN }}"
          echo "EXPO_TOKEN=${EXPO_TOKEN}" >> $GITHUB_ENV
          echo "âœ… Token configurado!"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ”‘ Setup Android keystore
        run: |
          echo "ğŸ”‘ Configurando keystore..."
          echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 --decode > my-release-key.jks
          
          cat > credentials.json << EOF
          {
            "android": {
              "keystore": {
                "keystorePath": "./my-release-key.jks",
                "keystorePassword": "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}",
                "keyAlias": "${{ secrets.ANDROID_KEY_ALIAS }}",
                "keyPassword": "${{ secrets.ANDROID_KEY_PASSWORD }}"
              }
            }
          }
          EOF
          
          echo "âœ… Keystore configurado!"

      - name: ğŸš€ Build with multiple methods
        run: |
          echo "ğŸš€ Tentando build com mÃºltiplos mÃ©todos..."
          
          # Configurar variÃ¡veis
          export EXPO_TOKEN="${{ secrets.EXPO_TOKEN }}"
          export EAS_NO_VCS=1
          export CI=1
          
          # MÃ©todo 1: EAS global
          echo "ğŸ”„ MÃ©todo 1: eas global"
          if command -v eas &> /dev/null; then
            echo "âœ… EAS global encontrado, tentando build..."
            eas build --platform android --profile ${{ github.event.inputs.profile }} --non-interactive --wait && exit 0
          else
            echo "âŒ EAS global nÃ£o encontrado"
          fi
          
          # MÃ©todo 2: EAS local
          echo "ğŸ”„ MÃ©todo 2: eas local"
          if [ -f "./node_modules/.bin/eas" ]; then
            echo "âœ… EAS local encontrado, tentando build..."
            ./node_modules/.bin/eas build --platform android --profile ${{ github.event.inputs.profile }} --non-interactive --wait && exit 0
          else
            echo "âŒ EAS local nÃ£o encontrado"
          fi
          
          # MÃ©todo 3: Usar expo-github-action
          echo "ğŸ”„ MÃ©todo 3: usando expo-github-action"
          npm install -g @expo/cli@latest
          npx expo install --fix
          npx @expo/cli@latest install eas-cli
          npx eas build --platform android --profile ${{ github.event.inputs.profile }} --non-interactive --wait || echo "âŒ MÃ©todo 3 falhou"

      - name: âœ… Success
        run: |
          echo "ğŸ‰ Build concluÃ­do!"
          echo "ğŸ“± Verifique em: https://expo.dev/accounts/pikulito/projects/corte-matos-app/builds"
